<style>
	/* Do not display page content until device content has been added */
	body {
		display: none;
	}

	/* Animate on background blur when loaded */
	body {
		animation: config-page-blur .8s;
		backdrop-filter: blur(1px);
		-webkit-backdrop-filter: blur(1px);
	}
	@keyframes config-page-blur {
		from {
			backdrop-filter: blur(0);
			-webkit-backdrop-filter: blur(0);
		}
		to {
			backdrop-filter: blur(1px);
			-webkit-backdrop-filter: blur(1px);
		}
	}

	/* Animate form and background blur away when canceled or submitted */
	body {
		transition: -webkit-backdrop-filter 0.8s;
	}
	form {
		transition: transform 0.8s;
	}
	.dying {
		backdrop-filter: blur(0);
		-webkit-backdrop-filter: blur(0);
	}
	.dying form {
		transform: translateY(calc(-100% - 2em));
	}
</style>
<script> // @ts-check
globalThis.promise = new Promise(async (resolve, reject) => {
	// Gets query parameters
	const queryParams = new URLSearchParams(location.search);

	try {
		// Adds CSS styling without requiring external file
		/** @type {HTMLIFrameElement} */(frameElement).style.border = "0";
		/** @type {HTMLIFrameElement} */(frameElement).style.width = "100%";
		/** @type {HTMLIFrameElement} */(frameElement).style.height = "100%";
		/** @type {HTMLIFrameElement} */(frameElement).style.position = "absolute";
		/** @type {HTMLIFrameElement} */(frameElement).style.top = "0";
		/** @type {HTMLIFrameElement} */(frameElement).style.left = "0";
		/** @type {HTMLIFrameElement} */(frameElement).style.zIndex = Number.MAX_SAFE_INTEGER.toString();

		// Gets device address from query parameters
		if (!queryParams.has("addr")) {
			return undefined;
		}
		const deviceAddr = `http://${queryParams.get("addr")}`;

		// Gets current nodes in DOM head before overwriting
		const oldHeadNodes = document.head.childNodes;

		// Overwrites DOM with device configuration page HTML
		const deviceConfigPageResponse = await fetch(deviceAddr);
		if (!deviceConfigPageResponse.ok) {
			throw new Error(deviceConfigPageResponse.statusText);
		}
		document.documentElement.innerHTML = await deviceConfigPageResponse.text();
		const form = document.querySelector("form");
		document.body.style.display = "block";

		// Runs supressed script tags that were inserted through innerHTML write
		const oldScriptNode = document.querySelector("script");
		const newScriptNode = document.createElement("script");
		newScriptNode.innerHTML = oldScriptNode.innerHTML;
		oldScriptNode.parentElement.insertBefore(newScriptNode, oldScriptNode);
		oldScriptNode.remove();

		// Inserts extra styles and script back to page after being overwritten
		document.head.append(...oldHeadNodes);

		// Renders host iframe in DOM
		/** @type {HTMLIFrameElement} */(frameElement).style.display = "block";

		// Delays events until after intro animation is finished
		await new Promise((resolve) => document.body.addEventListener("animationend", resolve, { once: true }));

		// Disables host wrapper iframe when animation is done for cancel or submit
		document.body.addEventListener("transitionend", () => {
			if (!document.body.classList.contains("dying")) return;
			/** @type {HTMLIFrameElement} */(frameElement).style.display = "none";
		});

		// Disables overlay form when clicked outside form element
		document.body.onclick = (event) => {
			// Ignores bubbling events
			if (event.target !== document.body) return;

			// Animates page off screen
			document.body.classList.add("dying");

			// Prevent multiple resolves from running active at the same time
			form.onsubmit = null;
			document.body.onclick = null;

			// Resolves promise indicating no configuration was sent
			resolve(false);
		};

		// Prevents submitting form since that updates the content of the page
		(await new Promise((resolve) => form.onsubmit = resolve)).preventDefault();

		// Animates page off screen
		document.body.classList.add("dying");

		// Prevent multiple resolves from running active at the same time
		form.onsubmit = null;
		document.body.onclick = null;

		// Manually submits form
		const postResponse = await fetch(deviceAddr, { method: "POST", body: new FormData(form) });
		if (!postResponse.ok) throw new Error(postResponse.statusText);

		// Resolves promise indicating configuration was successfully sent
		resolve(true);
	}
	catch (err) {
		// Rejects promise with caught error
		reject(err);

		// Opens alert box with error message if query parameter is set to alert
		if (queryParams.get("err") === "alert") {
			alert(err.message);
		}
	}
});
</script>
